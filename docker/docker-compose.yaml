version: '3.8'

services:
  # Claude skill runner service
  skill-runner:
    image: claude-skill-runner:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile

    environment:
      # Skill configuration
      - SKILL=${SKILL:-triage}
      - TASK_INPUT_PATH=/input/task-input.yaml
      - OUTPUT_PATH=/output
      - WORKSPACE_PATH=/workspace
      - ARTIFACTS_PATH=/artifacts

      # Claude API
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-sonnet-4-5-20250929}

      # Git configuration
      - GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME:-Claude Code Bot}
      - GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL:-claude-bot@anthropic.com}
      - GIT_COMMITTER_NAME=${GIT_COMMITTER_NAME:-Claude Code Bot}
      - GIT_COMMITTER_EMAIL=${GIT_COMMITTER_EMAIL:-claude-bot@anthropic.com}

      # GitHub (for PR operations)
      - GITHUB_TOKEN=${GITHUB_TOKEN}

      # Prefect (connect to existing tailscale instance)
      - PREFECT_API_URL=${PREFECT_API_URL}

    volumes:
      # Mount workspace (your code repository)
      - ${WORKSPACE_PATH:-../workspace}:/workspace

      # Mount input (task definition)
      - ${INPUT_PATH:-./input}:/input

      # Mount output (results)
      - ${OUTPUT_PATH:-./output}:/output

      # Mount artifacts (history/state)
      - ${ARTIFACTS_PATH:-./artifacts}:/artifacts

      # Mount Docker socket (for nested containers if needed)
      - /var/run/docker.sock:/var/run/docker.sock

      # Mount SSH keys (for git operations)
      - ${SSH_KEY_PATH:-~/.ssh}:/root/.ssh:ro

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

    # Restart policy
    restart: unless-stopped

    # Network
    network_mode: host  # Use host network to access tailscale

# Note: Prefect server and agent removed - using existing tailscale cluster instance
# Set PREFECT_API_URL environment variable to point to your Prefect instance
